---
paths: src/components/ui/pin*, src/lib/**/pin*, src/app/api/pinned/**, src/app/api/smart-pins/**
---

# Pinning System

Unified system for highlighting important items. All pins are **shared across all users** (family-wide).

## Pin Types

| Type | Color | Icon | Description | Action |
|------|-------|------|-------------|--------|
| Smart | Orange | Zap | Auto-generated by system | Dismiss (hides until criteria change) |
| User | Yellow | Star | Manually pinned | Unpin (deletes completely) |

## Database Schema

Table: `pinned_items`

Key fields:
- `entity_type` - vendor, bill, ticket, insurance_policy, property_tax, insurance_premium, buildinglink_message, document
- `entity_id` - UUID of the entity
- `is_system_pin` - true = smart pin, false = user pin
- `metadata` - JSONB cache (title, amount, due_date, priority)
- `dismissed_at` - smart pins only (user pins are deleted)

UNIQUE constraint on `(entity_type, entity_id)` - one pin per item.

## Smart Pin Criteria

| Source | Criteria | Function |
|--------|----------|----------|
| Bills | Due <=7 days OR overdue OR unconfirmed checks >14 days | `syncSmartPinsBills()` |
| Tickets | Urgent/high priority, status = pending/in_progress | `syncSmartPinsTickets()` |
| BuildingLink | Critical/important messages, uncollected packages | `syncSmartPinsBuildingLink()` |

## Sync Triggers

Smart pins auto-sync after mutations:

```typescript
// src/lib/mutations.ts
await confirmBillPayment(id)
await syncSmartPinsBills()  // removes from smart pins

await updateBill(id, { status })
if (statusChanged || dueDateChanged) await syncSmartPinsBills()

await updateTicket(id, { priority })
if (priorityChanged) await syncSmartPinsTickets()

await closeTicket(id)
await syncSmartPinsTickets()  // removes from smart pins
```

**Background sync:** Unified worker (`app-worker-1`) runs sync every 60 minutes via `/api/cron/sync-smart-pins`

## User Workflows

**Dismiss smart pin (orange):**
1. Click orange star → sets `dismissed_at`
2. 10-second toast with Undo
3. Won't reappear unless: Reset All in Settings, or conditions change significantly

**Unpin user pin (yellow):**
1. Click yellow star → deletes row
2. No undo (permanent)

**Create user pin:**
1. Click gray star → inserts with `is_system_pin = false`
2. Shared immediately with all family members

## UI Components

- `src/components/ui/pin-button.tsx` - Universal star button
- `src/components/ui/pinned-section.tsx` - Accented card wrapper

**Placement:** Pin button is **leftmost** in all rows: `[Star] [Icon] [Content...] [Actions]`

## API Endpoints

| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/api/pinned/list` | POST | Get pinned IDs by entity type |
| `/api/pinned/toggle` | POST | Toggle pin state |
| `/api/pinned/undo` | POST | Restore dismissed smart pin |
| `/api/smart-pins/reset` | POST | Clear dismissals, re-sync (owner-only) |

## Performance Indexes

See `scripts/migrations/023-pinned-items-indexes.sql`:
- `idx_pinned_items_smart_active` - Hot path for active smart pins
- `idx_pinned_items_entity_lookup` - Fast entity lookup
- `idx_pinned_items_dismissed_at` - Dismissal analytics

## Rules

**DO:**
- Keep metadata minimal (only display fields)
- Run sync after mutations affecting pin criteria
- Show undo for smart pin dismissals (10s window)

**DON'T:**
- Delete smart pins (dismiss instead)
- Store full entities in metadata
- Create user pins programmatically (UI only)
- Show undo for user pin deletions
